<%ARGS>
</%ARGS>

<%INIT>
$RT::EmailCompletionNonPrivileged ||= '';
$RT::EmailCompletionSearchFields  ||= [qw(EmailAddress)];
$RT::EmailCompletionSearch        ||= 'LIKE';

my $CurrentUser = $session{CurrentUser};

# by default SelfService users aren't allowed to use EmailCompletion
$m->abort
    unless $CurrentUser->Privileged() or $RT::EmailCompletionUnprivileged;

my $Email;

# whatever the argument, we want to find by email
for (keys %ARGS) {
  $Email = $ARGS{$_}, last
     if defined $ARGS{$_};
}

my @emails = RTx::EmailCompletion::search_rdbms($Email, $CurrentUser);

my $users = qq{<ul class="contacts">};
for my $email (@emails) {
    $users .= qq{<li class="contact"><div class="email">$email</div></li>};
}
$users .= '</ul>';

$m->out($users);
$m->abort;

</%INIT>

<%ONCE>
use RTx::EmailCompletion;
</%ONCE>
